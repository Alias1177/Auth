#!/bin/bash

# –ò–º—è Docker-–æ–±—Ä–∞–∑–∞ —Å –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–º –º–∏–≥—Ä–∞—Ü–∏–∏
MIGRATE_IMAGE="auth-app"

# –°–µ—Ç—å Docker, –≤ –∫–æ—Ç–æ—Ä–æ–π –Ω–∞—Ö–æ–¥—è—Ç—Å—è PostgreSQL –∏ Redis
DOCKER_NETWORK="bridge"

# –°—Ç—Ä–æ–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ PostgreSQL
DATABASE_DSN="${DATABASE_DSN:-postgres://admin:secret@postgres:5432/mydb?sslmode=disable}"

# –ê–¥—Ä–µ—Å Redis
REDIS_ADDR="${REDIS_ADDR:-redis:6379}"

# –ü—É—Ç—å –∫ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è –ø—Ä–æ–µ–∫—Ç–∞)
MIGRATIONS_PATH="./db/migrations"

# ----------------------------------------------------------------------
# –ü—Ä–æ–≤–µ—Ä–∫–∏
# ----------------------------------------------------------------------

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ª–∏ Docker
if ! command -v docker &> /dev/null
then
    echo "‚ùå Docker –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Docker –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞."
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏
if ! [ -d "$MIGRATIONS_PATH" ]; then
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è —Å –º–∏–≥—Ä–∞—Ü–∏—è–º–∏ '$MIGRATIONS_PATH' –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."
    exit 1
fi

# ----------------------------------------------------------------------
# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
# ----------------------------------------------------------------------

log() {
    local level="$1"
    shift
    local message="$@"
    local timestamp=$(date "+%Y-%m-%d %H:%M:%S")

    if [ -n "$LOG_FILE" ]; then
        echo "$timestamp [$level] $message" >> "$LOG_FILE"
    fi
    echo "$timestamp [$level] $message"
}

# ----------------------------------------------------------------------
# –ó–∞–ø—É—Å–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –¥–ª—è –æ—Ç–∫–∞—Ç–∞
# ----------------------------------------------------------------------

log "INFO" "üöÄ –ó–∞–ø—É—Å–∫ –æ—Ç–∫–∞—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏–π..."

docker run --rm -it \
    --network="$DOCKER_NETWORK" \
    -e DATABASE_DSN="$DATABASE_DSN" \
    -e REDIS_ADDR="$REDIS_ADDR" \
    -v "$(pwd)/$MIGRATIONS_PATH:/app/db/migrations" \
    "$MIGRATE_IMAGE" \
    /app/migrate -down -postgres -redis

# ----------------------------------------------------------------------
# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
# ----------------------------------------------------------------------

# –ü–æ–ª—É—á–∞–µ–º –∫–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–π –∫–æ–º–∞–Ω–¥—ã
RESULT=$?

if [ "$RESULT" -ne 0 ]; then
    log "ERROR" "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–∞—Ç–µ –º–∏–≥—Ä–∞—Ü–∏–π. –ö–æ–¥ –≤–æ–∑–≤—Ä–∞—Ç–∞: $RESULT"
    exit 1
else
    log "INFO" "‚úÖ –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–π —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω."
fi

log "INFO" "‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à–µ–Ω."
exit 0